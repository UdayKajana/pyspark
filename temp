from jinja2 import Environment, FileSystemLoader
import yaml
import os
import sys
import re

def validate_file_path(file_path: str) -> bool:
    """Validate if the file path has an allowed extension."""
    _, ext = os.path.splitext(file_path)
    return ext.lower() in ['.yml', '.yaml', '.jinja2', '.py']

def sanitize_filename(filename):
    return re.sub(r'[^\w\-_\.]', '_', filename)

def validate_output_path(base_path: str, output_path: str) -> bool:
    """
    Validate that the output path is within the intended base directory.
    """
    base_abs = os.path.abspath(base_path)
    output_abs = os.path.abspath(output_path)
    return os.path.commonprefix([base_abs, output_abs]) == base_abs

def create_dag_files(config_path, dag_files_path, project):
    BASE_DIR = os.path.dirname(os.path.abspath(__file__))
    
    # Validate input paths
    if not os.path.exists(dag_files_path) or not os.path.isdir(dag_files_path):
        raise ValueError(f"Invalid DAG files directory: {dag_files_path}")
    
    env = Environment(loader=FileSystemLoader(BASE_DIR))
    template = env.get_template('template.jinja2')
    
    if not validate_file_path(config_path):
        raise ValueError(f"Invalid file path or extension: {config_path}")
    
    with open(f"{config_path}", "r") as configfile:
        config_data = yaml.safe_load(configfile)
        markets = config_data[project][0]
        market = {}
        
        for x in markets:
            market['technologies'] = x['technologies']
            market['recon_days'] = x['recon_days']
            market['ds'] = '{{ data_interval_end.strftime("%Y-%m-%d") }}'
            market['ds_nodash'] = '{{ data_interval_end.strftime("%Y%m%d") }}'
            market['schedule'] = x['schedule']
            market['is_exists'] = "{{ task_instance.xcom_pull(task_ids='market_file_exists_check_task', key='market_exists') }}"
            market['market_name'] = sanitize_filename(x['market_name'])
            
            # Create and validate output path
            output_file = os.path.join(dag_files_path, f"dtwin_ran_invtry_nokia_{x['market_name']}.py")
            
            # Check if output path is safe
            if not validate_output_path(dag_files_path, output_file):
                raise ValueError(f"Invalid output path detected: {output_file}")
            
            with open(output_file, 'w+') as f:
                f.write(template.render(market))

if __name__ == "__main__":
    config_path = str(sys.argv[1])
    dag_files_path = str(sys.argv[2])
    project = str(sys.argv[3])
    create_dag_files(config_path, dag_files_path, project)
